package ive_login;

import java.sql.Timestamp;
import java.util.List;
import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        Scanner sc = new Scanner(System.in);
        UserDAO dao = new UserDAO();
        String loggedInUser = null;

        mainLoop: while (true) {
            printHeader("ì§„ì‹¤ì˜ ë°©ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤");
            System.out.println("1> ë¡œê·¸ì¸ ğŸ”");
            System.out.println("2> ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ğŸ‘¤ (ì¡°íšŒë§Œ ê°€ëŠ¥)");
            System.out.println("0> ì¢…ë£Œ âŒ");
            String menu = readMenuOption(sc, "\në©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” > ");

            switch (menu) {
                case "1":
                    printHeader("ë¡œê·¸ì¸");
                    System.out.print("ì•„ì´ë”” : ");
                    String id = sc.nextLine();
                    System.out.print("ë¹„ë°€ë²ˆí˜¸ : ");
                    String pw = sc.nextLine();

                    if (dao.login(id, pw)) {
                        loggedInUser = id;
                        System.out.println("âœ… ë¡œê·¸ì¸ ì„±ê³µ! [" + loggedInUser + "] ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.");
                        categoryMenu(sc, dao, loggedInUser);
                        loggedInUser = null;
                    } else {
                        printHeader("ë¡œê·¸ì¸ ì‹¤íŒ¨");
                        System.out.println("âŒ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        if (!readYesNo(sc, "ë‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n) > ")) {
                            break mainLoop;
                        }
                    }
                    break;

                case "2":
                    System.out.println("ğŸšª ê²ŒìŠ¤íŠ¸ ëª¨ë“œëŠ” í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
                    break;

                case "0":
                    System.out.println("ğŸ‘‹ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
                    break mainLoop;

                default:
                    System.out.println("â— ì˜¬ë°”ë¥¸ ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        }
        sc.close();
    }

    public static void categoryMenu(Scanner sc, UserDAO dao, String loggedInUser) {
        categoryLoop: while (true) {
            printHeader("ì¹´í…Œê³ ë¦¬");
            System.out.println("1> ê²Œì‹œíŒ ğŸ“");
            System.out.println("2> ì‚¬ì§„ ğŸ“·");
            System.out.println("3> ë™ì˜ìƒ ğŸ¥");
            String input = readMenuOption(sc, "\në©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (ë¡œê·¸ì•„ì›ƒ: 0) > ");

            String category = switch (input) {
                case "1" -> "home";
                case "2" -> "photo";
                case "3" -> "video";
                case "0" -> null;
                default -> {
                    System.out.println("â— ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. ê¸°ë³¸ê°’ 'home'ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    yield "home";
                }
            };

            if (category == null) {
                System.out.println("ğŸ‘‹ ë¡œê·¸ì•„ì›ƒí•˜ê³  ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
                break categoryLoop;
            }

            boardMenu(sc, dao, loggedInUser, category);
        }
    }

    public static void boardMenu(Scanner sc, UserDAO dao, String loggedInUser, String category) {
        boardLoop: while (true) {
            List<Post> posts = dao.getPostsByCategory(category);
            printHeader(category.toUpperCase() + " ê²Œì‹œíŒ");

            if (posts.isEmpty()) {
                System.out.println("ğŸ“­ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
            } else {
                for (Post p : posts) {
                    // ë‚ ì§œê³ ì •!
                    String dateTimeStr = "2299-12-31 | 23:59";

                    System.out.printf("%d> %s  | [ì‘ì„±ì] %s | ì¡°íšŒìˆ˜ (%d) | ì¶”ì²œìˆ˜ (%d) | %s\n",
                        p.getBoardNo(), p.getTitle(), p.getWriter(), p.getViewCount(), p.getLikeCount(), dateTimeStr);
                }
            }

            System.out.println("\n1> ê²Œì‹œê¸€ ì¡°íšŒ ğŸ”");
            System.out.println("2> ê¸€ ì‘ì„± âœï¸");
            System.out.println("0> ë’¤ë¡œê°€ê¸° ğŸ”™");
            String input = readMenuOption(sc, "\në©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” > ");

            switch (input) {
                case "1":
                    int boardNo = readInt(sc, "ì¡°íšŒí•  ê²Œì‹œê¸€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” > ");
                    Post post = posts.stream().filter(p -> p.getBoardNo() == boardNo).findFirst().orElse(null);
                    if (post == null) {
                        System.out.println("â— í•´ë‹¹ ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        continue;
                    }
                    dao.increaseViewCount(boardNo);
                    postDetailMenu(sc, dao, loggedInUser, dao.getPostByBoardNo(boardNo));
                    break;

                case "2":
                    printHeader("ê²Œì‹œê¸€ ì‘ì„±");
                    System.out.println("ì‘ì„±ì > " + loggedInUser);
                    System.out.print("ì œëª© > ");
                    String title = sc.nextLine();
                    System.out.print("ë‚´ìš© > ");
                    String content = sc.nextLine();
                    if (readYesNo(sc, "ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n) > ")) {
                        Post newPost = new Post(title, loggedInUser, content, category);
                        if (dao.insertPost(newPost)) {
                            System.out.println("âœ… ì‘ì„± ì™„ë£Œ! ê²Œì‹œíŒìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                        } else {
                            System.out.println("âŒ ì‘ì„± ì‹¤íŒ¨...");
                        }
                    }
                    break;

                case "0":
                    break boardLoop;

                default:
                    System.out.println("â— ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤.");
            }
        }
    }

    public static void postDetailMenu(Scanner sc, UserDAO dao, String loggedInUser, Post post) {
        detailLoop: while (true) {
            post.setComments(dao.getCommentsByBoardNo(post.getBoardNo()));
            System.out.println("ğŸ“Œ ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°");
            System.out.println("======================================================================");

            // ë‚ ì§œ/ì‹œê°„ ê³ ì •!
            String fakeDate = "2299-12-31";
            String fakeTime = "23:59";

            System.out.printf("ì œëª©: %s | ì‘ì„±ì: %s | ì¡°íšŒìˆ˜: %d | ì¶”ì²œìˆ˜: %d | %s | %s\n",
                post.getTitle(), post.getWriter(), post.getViewCount(), post.getLikeCount(), fakeDate, fakeTime);

            System.out.println();
            System.out.printf("ë‚´ìš©: %s\n", post.getContent());

            System.out.println("\n---- ğŸ’¬ ëŒ“ê¸€ ëª©ë¡ ----");
            List<Comment> comments = post.getComments();
            if (comments.isEmpty()) {
                System.out.println("ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
            } else {
                comments.forEach(c -> System.out.printf("%d / %s: %s\n", c.getCommentId(), c.getWriter(), c.getContent()));
            }

            System.out.println("\n1> ëŒ“ê¸€ ì‘ì„± âœï¸");
            System.out.println("2> ëŒ“ê¸€ ì‚­ì œ ğŸ—‘ï¸");
            System.out.println("3> ì¶”ì²œ ğŸ‘");
            System.out.println("4> ê³µìœ  ğŸ”—");
            System.out.println("5> ê²Œì‹œê¸€ ì‚­ì œ âŒ");
            System.out.println("0> ë’¤ë¡œê°€ê¸° ğŸ”™");
            String input = readMenuOption(sc, "ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” > ");

            switch (input) {
                case "1":
                    commentWriteLoop: while (true) {
                        printHeader("ëŒ“ê¸€ ì‘ì„±");
                        System.out.println("ëŒ“ê¸€ ì‘ì„±ì > " + loggedInUser);
                        System.out.print("ëŒ“ê¸€ ë‚´ìš© ì…ë ¥ (ë’¤ë¡œê°€ê¸°: 0) > ");
                        String cContent = sc.nextLine();
                        if ("0".equals(cContent)) break commentWriteLoop;
                        if (readYesNo(sc, "ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n) > ")) {
                            Comment comment = new Comment(0, post.getBoardNo(), loggedInUser, cContent);
                            System.out.println(dao.insertComment(comment) ? "âœ… ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ!" : "âŒ ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨...");
                            break commentWriteLoop;
                        } else {
                            break commentWriteLoop;
                        }
                    }
                    break;

                case "2":
                    commentDeleteLoop: while (true) {
                        printHeader("ëŒ“ê¸€ ì‚­ì œ");
                        post.getComments().forEach(c ->
                            System.out.printf("%d / %s: %s\n", c.getCommentId(), c.getWriter(), c.getContent())
                        );
                        System.out.print("ì‚­ì œí•  ëŒ“ê¸€ ë²ˆí˜¸ ì…ë ¥ (ë’¤ë¡œê°€ê¸°: 0) > ");
                        String inputStr = sc.nextLine();
                        if ("0".equals(inputStr)) break commentDeleteLoop;

                        int cId;
                        try {
                            cId = Integer.parseInt(inputStr);
                        } catch (NumberFormatException e) {
                            System.out.println("â— ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                            continue;
                        }
                        if (readYesNo(sc, "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n) > ")) {
                            System.out.println(dao.deleteComment(cId, loggedInUser)
                                    ? "âœ… ì‚­ì œ ì™„ë£Œ!" : "âŒ ì‚­ì œ ì‹¤íŒ¨ (ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥)");
                            break commentDeleteLoop;
                        } else {
                            break commentDeleteLoop;
                        }
                    }
                    break;

                case "3":
                    if (dao.increaseLikeCount(post.getBoardNo())) {
                        post.setLikeCount(post.getLikeCount() + 1);
                        System.out.println("ğŸ‘ ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    } else {
                        System.out.println("âŒ ì¶”ì²œ ì‹¤íŒ¨ (ì¤‘ë³µ ì¶”ì²œ ë¶ˆê°€ í˜¹ì€ ê¸°íƒ€ ì˜¤ë¥˜)...");
                    }
                    break;

                case "4":
                    shareMenu(sc);
                    break;

                case "5":
                    if (loggedInUser.equals(post.getWriter())) {
                        if (readYesNo(sc, "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n) > ")) {
                            if (dao.deletePost(post)) {
                                System.out.println("âœ… ê²Œì‹œê¸€ ì‚­ì œ ì™„ë£Œ!");
                                break detailLoop;
                            } else {
                                System.out.println("âŒ ì‚­ì œ ì‹¤íŒ¨...");
                            }
                        }
                    } else {
                        System.out.println("âŒ ë³¸ì¸ ê²Œì‹œê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    }
                    break;

                case "0":
                    break detailLoop;

                default:
                    System.out.println("â— ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤.");
            }
        }
    }

    public static void shareMenu(Scanner sc) {
        printHeader("ê³µìœ ");
        System.out.println("1> X (êµ¬ Twitter)");
        System.out.println("2> ì¸ìŠ¤íƒ€ê·¸ë¨ ğŸ“¸");
        System.out.println("3> í‹±í†¡ ğŸµ");
        System.out.println("0> ì·¨ì†Œ");
        String input = readMenuOption(sc, "ê³µìœ í•  í”Œë«í¼ ì„ íƒ (ì·¨ì†Œ: 0) > ");

        String link = switch (input) {
            case "1" -> "https://x.com";
            case "2" -> "https://instagram.com";
            case "3" -> "https://tiktok.com";
            case "0" -> null;
            default -> null;
        };

        if (link != null) {
            System.out.println("ğŸ”— ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤! > " + link);
        } else {
            System.out.println("â— ê³µìœ ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    public static void printHeader(String title) {
        String line = "=".repeat(70);
        System.out.println("\n" + line);
        System.out.println("ğŸ“Œ " + title);
        System.out.println(line + "\n");
    }

    public static String readMenuOption(Scanner sc, String prompt) {
        while (true) {
            System.out.print(prompt);
            String input = sc.nextLine().trim();
            if (input.matches("[0-9]+")) return input;
            System.out.println("â— ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
    }

    public static int readInt(Scanner sc, String prompt) {
        while (true) {
            System.out.print(prompt);
            try {
                return Integer.parseInt(sc.nextLine().trim());
            } catch (NumberFormatException e) {
                System.out.println("â— ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        }
    }

    public static boolean readYesNo(Scanner sc, String prompt) {
        while (true) {
            System.out.print(prompt);
            String input = sc.nextLine().trim().toLowerCase();
            if (input.equals("y")) return true;
            if (input.equals("n")) return false;
            System.out.println("â— ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”. (y/n)");
        }
    }
}
